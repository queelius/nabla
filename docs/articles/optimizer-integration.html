<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Optimizer Integration • dualr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Optimizer Integration">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dualr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/higher-order.html">Higher-Order Derivatives</a>
    </li>
    <li>
      <a href="../articles/introduction.html">Introduction to dualr</a>
    </li>
    <li>
      <a href="../articles/mle-workflow.html">MLE Workflow with dualr</a>
    </li>
    <li>
      <a href="../articles/optimizer-integration.html">Optimizer Integration</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/queelius/dualr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Optimizer Integration</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/queelius/dualr/blob/HEAD/vignettes/optimizer-integration.Rmd" class="external-link"><code>vignettes/optimizer-integration.Rmd</code></a></small>
      <div class="hidden name"><code>optimizer-integration.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/queelius/dualr" class="external-link">dualr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dualr'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     deriv</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code><a href="../reference/score.html">score()</a></code> and <code><a href="../reference/hessian.html">hessian()</a></code> functions in
<code>dualr</code> return <strong>plain numeric vectors and
matrices</strong> — exactly what R’s built-in optimizers expect. This
vignette shows how to plug AD derivatives into <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> and
<code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb()</a></code> for maximum likelihood estimation.</p>
<p><strong>The integration pattern:</strong></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># optim() with AD gradient</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span><span class="va">start</span>, fn <span class="op">=</span> <span class="va">nll</span>, gr <span class="op">=</span> <span class="va">ngr</span>, method <span class="op">=</span> <span class="st">"BFGS"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># nlminb() with AD gradient + Hessian</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">start</span>, objective <span class="op">=</span> <span class="va">nll</span>, gradient <span class="op">=</span> <span class="va">ngr</span>, hessian <span class="op">=</span> <span class="va">nhess</span><span class="op">)</span></span></code></pre></div>
<p><strong>Sign convention:</strong> Both <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> and
<code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb()</a></code> <strong>minimize</strong>. For MLE (maximizing the
log-likelihood), negate everything:</p>
<ul>
<li><code>fn = function(theta) -loglik(theta)</code></li>
<li><code>gr = function(theta) -score(loglik, theta)</code></li>
<li><code>hessian = function(theta) -hessian(loglik, theta)</code></li>
</ul>
<p><strong>Key difference between optimizers:</strong></p>
<table class="table">
<colgroup>
<col width="33%">
<col width="33%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th></th>
<th><code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code></th>
<th><code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb()</a></code></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Gradient function</td>
<td>
<code>gr</code> argument (used during optimization)</td>
<td>
<code>gradient</code> argument</td>
</tr>
<tr class="even">
<td>Hessian function</td>
<td>Not supported — <code>hessian=TRUE</code> only computes it
<em>after</em> convergence</td>
<td>
<code>hessian</code> argument (used during optimization)</td>
</tr>
<tr class="odd">
<td>Best use</td>
<td>BFGS with AD gradient</td>
<td>Full second-order optimization</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="optim-with-ad-gradients">
<code>optim()</code> with AD gradients<a class="anchor" aria-label="anchor" href="#optim-with-ad-gradients"></a>
</h2>
<p>Let’s fit a
Normal(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>μ</mi><annotation encoding="application/x-tex">\mu</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>)
model using <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code>. First, define the log-likelihood with
sufficient statistics:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">data_norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>, mean <span class="op">=</span> <span class="fl">5</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">data_norm</span><span class="op">)</span></span>
<span><span class="va">sum_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_norm</span><span class="op">)</span></span>
<span><span class="va">sum_x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_norm</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ll_normal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="va">theta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="op">-</span><span class="va">n</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">sigma</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">sum_x2</span> <span class="op">-</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">mu</span> <span class="op">*</span> <span class="va">sum_x</span> <span class="op">+</span> <span class="va">n</span> <span class="op">*</span> <span class="va">mu</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now compare BFGS <strong>with</strong> and <strong>without</strong>
the AD gradient:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Negated versions for minimization</span></span>
<span><span class="va">nll</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">-</span><span class="fu">ll_normal</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></span>
<span><span class="va">ngr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">-</span><span class="fu"><a href="../reference/score.html">score</a></span><span class="op">(</span><span class="va">ll_normal</span>, <span class="va">theta</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Without gradient: optim uses internal finite differences</span></span>
<span><span class="va">fit_no_gr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, fn <span class="op">=</span> <span class="va">nll</span>, method <span class="op">=</span> <span class="st">"BFGS"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># With AD gradient</span></span>
<span><span class="va">fit_ad_gr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, fn <span class="op">=</span> <span class="va">nll</span>, gr <span class="op">=</span> <span class="va">ngr</span>, method <span class="op">=</span> <span class="st">"BFGS"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"BFGS (no gradient)"</span>, <span class="st">"BFGS (AD gradient)"</span><span class="op">)</span>,</span>
<span>  mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">fit_no_gr</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">fit_ad_gr</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">fit_no_gr</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">fit_ad_gr</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  fn_calls <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">fit_no_gr</span><span class="op">$</span><span class="va">counts</span><span class="op">[</span><span class="st">"function"</span><span class="op">]</span>, <span class="va">fit_ad_gr</span><span class="op">$</span><span class="va">counts</span><span class="op">[</span><span class="st">"function"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  gr_calls <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">fit_no_gr</span><span class="op">$</span><span class="va">counts</span><span class="op">[</span><span class="st">"gradient"</span><span class="op">]</span>, <span class="va">fit_ad_gr</span><span class="op">$</span><span class="va">counts</span><span class="op">[</span><span class="st">"gradient"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  convergence <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">fit_no_gr</span><span class="op">$</span><span class="va">convergence</span>, <span class="va">fit_ad_gr</span><span class="op">$</span><span class="va">convergence</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;               method       mu    sigma fn_calls gr_calls convergence</span></span>
<span><span class="co">#&gt; 1 BFGS (no gradient) 98.48163 563.4469      101      100           1</span></span>
<span><span class="co">#&gt; 2 BFGS (AD gradient) 98.48162 563.4456      101      100           1</span></span></code></pre></div>
<p>Both reach the same MLE, but the AD gradient version typically uses
fewer function evaluations because it has exact gradient
information.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Verify against analytical MLE</span></span>
<span><span class="va">mle_mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">data_norm</span><span class="op">)</span></span>
<span><span class="va">mle_sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">data_norm</span> <span class="op">-</span> <span class="va">mle_mu</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Analytical MLE: mu ="</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">mle_mu</span>, <span class="fl">6</span><span class="op">)</span>, <span class="st">" sigma ="</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">mle_sigma</span>, <span class="fl">6</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Analytical MLE: mu = 5.06503  sigma = 2.072274</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"optim+AD MLE:   mu ="</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">fit_ad_gr</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>    <span class="st">" sigma ="</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">fit_ad_gr</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">6</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; optim+AD MLE:   mu = 98.48162  sigma = 563.4456</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="nlminb-with-ad-gradient-hessian">
<code>nlminb()</code> with AD gradient + Hessian<a class="anchor" aria-label="anchor" href="#nlminb-with-ad-gradient-hessian"></a>
</h2>
<p><code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb()</a></code> is the only base R optimizer that accepts a
<strong>Hessian function</strong> argument, making it the natural target
for second-order AD:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nhess</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">-</span><span class="fu"><a href="../reference/hessian.html">hessian</a></span><span class="op">(</span><span class="va">ll_normal</span>, <span class="va">theta</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_nlminb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                     objective <span class="op">=</span> <span class="va">nll</span>,</span>
<span>                     gradient <span class="op">=</span> <span class="va">ngr</span>,</span>
<span>                     hessian <span class="op">=</span> <span class="va">nhess</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"nlminb MLE: mu ="</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">fit_nlminb</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>    <span class="st">" sigma ="</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">fit_nlminb</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">6</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; nlminb MLE: mu = 5.06503  sigma = 2.072274</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Converged:"</span>, <span class="va">fit_nlminb</span><span class="op">$</span><span class="va">convergence</span> <span class="op">==</span> <span class="fl">0</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Converged: TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Iterations:"</span>, <span class="va">fit_nlminb</span><span class="op">$</span><span class="va">iterations</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Iterations: 11</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Function evaluations:"</span>, <span class="va">fit_nlminb</span><span class="op">$</span><span class="va">evaluations</span><span class="op">[</span><span class="st">"function"</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Function evaluations: 12</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Gradient evaluations:"</span>, <span class="va">fit_nlminb</span><span class="op">$</span><span class="va">evaluations</span><span class="op">[</span><span class="st">"gradient"</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Gradient evaluations: 11</span></span></code></pre></div>
<p>With exact Hessian information, <code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb()</a></code> can achieve
faster convergence than quasi-Newton methods (like BFGS) that
approximate the Hessian from gradient history.</p>
</div>
<div class="section level2">
<h2 id="logistic-regression-example">Logistic regression example<a class="anchor" aria-label="anchor" href="#logistic-regression-example"></a>
</h2>
<p>To demonstrate multi-parameter optimization, let’s fit a logistic
regression and compare with R’s <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simulate data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">7</span><span class="op">)</span></span>
<span><span class="va">n_lr</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_lr</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_lr</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span></span>
<span><span class="va">beta_true</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">1.2</span>, <span class="op">-</span><span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="va">eta_true</span> <span class="op">&lt;-</span> <span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta_true</span></span>
<span><span class="va">prob_true</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">eta_true</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n_lr</span>, <span class="fl">1</span>, <span class="va">prob_true</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Log-likelihood for dualr</span></span>
<span><span class="va">ll_logistic</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dual_constant.html">dual_constant</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_lr</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">eta_i</span> <span class="op">&lt;-</span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">theta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">theta</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span><span class="va">i</span>, <span class="fl">3</span><span class="op">]</span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="va">result</span> <span class="op">+</span> <span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="va">eta_i</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">eta_i</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">result</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Numeric version for optim's fn</span></span>
<span><span class="va">ll_logistic_num</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">beta</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">eta</span> <span class="op">&lt;-</span> <span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">y</span> <span class="op">*</span> <span class="va">eta</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">eta</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Fit with <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> using the AD gradient:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nll_lr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">-</span><span class="fu">ll_logistic_num</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></span>
<span><span class="va">ngr_lr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">-</span><span class="fu"><a href="../reference/score.html">score</a></span><span class="op">(</span><span class="va">ll_logistic</span>, <span class="va">theta</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_lr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, fn <span class="op">=</span> <span class="va">nll_lr</span>, gr <span class="op">=</span> <span class="va">ngr_lr</span>, method <span class="op">=</span> <span class="st">"BFGS"</span><span class="op">)</span></span></code></pre></div>
<p>Compare with <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_glm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Coefficient comparison</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Intercept"</span>, <span class="st">"x1"</span>, <span class="st">"x2"</span><span class="op">)</span>,</span>
<span>  optim_AD <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">fit_lr</span><span class="op">$</span><span class="va">par</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>  glm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit_glm</span><span class="op">)</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>  difference <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">fit_lr</span><span class="op">$</span><span class="va">par</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit_glm</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;             parameter  optim_AD       glm  difference</span></span>
<span><span class="co">#&gt; (Intercept) Intercept -0.703586 -0.703587  1.5805e-06</span></span>
<span><span class="co">#&gt; x1                 x1  1.345038  1.345043 -5.7000e-06</span></span>
<span><span class="co">#&gt; x2                 x2 -0.881894 -0.881896  2.3194e-06</span></span></code></pre></div>
<p>The AD-based optimizer recovers the same coefficients as
<code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code>.</p>
</div>
<div class="section level2">
<h2 id="standard-errors-from-the-hessian">Standard errors from the Hessian<a class="anchor" aria-label="anchor" href="#standard-errors-from-the-hessian"></a>
</h2>
<p>After optimization, the observed information matrix (negative Hessian
at the MLE) provides the asymptotic variance-covariance matrix of the
estimator:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">Var</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>θ</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>≈</mo><mi>I</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>θ</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">[</mo><mo>−</mo><mi>H</mi><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>θ</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\text{Var}(\hat\theta) \approx I(\hat\theta)^{-1} = [-H(\hat\theta)]^{-1}</annotation></semantics></math></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Observed information at the MLE</span></span>
<span><span class="va">obs_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/observed_information.html">observed_information</a></span><span class="op">(</span><span class="va">ll_logistic</span>, <span class="va">fit_lr</span><span class="op">$</span><span class="va">par</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Variance-covariance matrix</span></span>
<span><span class="va">vcov_ad</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">obs_info</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Standard errors</span></span>
<span><span class="va">se_ad</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">vcov_ad</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare with glm's standard errors</span></span>
<span><span class="va">se_glm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit_glm</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span>, <span class="st">"Std. Error"</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Intercept"</span>, <span class="st">"x1"</span>, <span class="st">"x2"</span><span class="op">)</span>,</span>
<span>  SE_AD <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">se_ad</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>  SE_glm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">se_glm</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>  ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">se_ad</span> <span class="op">/</span> <span class="va">se_glm</span>, <span class="fl">8</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;             parameter    SE_AD   SE_glm    ratio</span></span>
<span><span class="co">#&gt; (Intercept) Intercept 0.186306 0.186293 1.000069</span></span>
<span><span class="co">#&gt; x1                 x1 0.228300 0.228277 1.000101</span></span>
<span><span class="co">#&gt; x2                 x2 0.188825 0.188810 1.000077</span></span></code></pre></div>
<p>The standard errors from AD’s exact Hessian match
<code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code>’s Fisher-scoring estimates closely (the ratio should
be very near 1.0).</p>
</div>
<div class="section level2">
<h2 id="convergence-comparison">Convergence comparison<a class="anchor" aria-label="anchor" href="#convergence-comparison"></a>
</h2>
<p>Let’s compare how many iterations each optimizer strategy needs by
tracking the negative log-likelihood at each step:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Track convergence for three methods on the Normal(mu, sigma) model</span></span>
<span><span class="co"># We'll use a callback-style approach via optim's trace</span></span>
<span></span>
<span><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Method 1: Nelder-Mead (no gradient)</span></span>
<span><span class="va">fit_nm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span><span class="va">start</span>, fn <span class="op">=</span> <span class="va">nll</span>, method <span class="op">=</span> <span class="st">"Nelder-Mead"</span>,</span>
<span>                control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit <span class="op">=</span> <span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Method 2: BFGS with AD gradient</span></span>
<span><span class="va">fit_bfgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span><span class="va">start</span>, fn <span class="op">=</span> <span class="va">nll</span>, gr <span class="op">=</span> <span class="va">ngr</span>, method <span class="op">=</span> <span class="st">"BFGS"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Method 3: nlminb with AD gradient + Hessian</span></span>
<span><span class="va">fit_nlm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">start</span>, objective <span class="op">=</span> <span class="va">nll</span>, gradient <span class="op">=</span> <span class="va">ngr</span>, hessian <span class="op">=</span> <span class="va">nhess</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Summary comparison</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Nelder-Mead"</span>, <span class="st">"BFGS + AD grad"</span>, <span class="st">"nlminb + AD grad+hess"</span><span class="op">)</span>,</span>
<span>  fn_evals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">fit_nm</span><span class="op">$</span><span class="va">counts</span><span class="op">[</span><span class="st">"function"</span><span class="op">]</span>,</span>
<span>               <span class="va">fit_bfgs</span><span class="op">$</span><span class="va">counts</span><span class="op">[</span><span class="st">"function"</span><span class="op">]</span>,</span>
<span>               <span class="va">fit_nlm</span><span class="op">$</span><span class="va">evaluations</span><span class="op">[</span><span class="st">"function"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  converged <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">fit_nm</span><span class="op">$</span><span class="va">convergence</span> <span class="op">==</span> <span class="fl">0</span>,</span>
<span>                <span class="va">fit_bfgs</span><span class="op">$</span><span class="va">convergence</span> <span class="op">==</span> <span class="fl">0</span>,</span>
<span>                <span class="va">fit_nlm</span><span class="op">$</span><span class="va">convergence</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>  nll <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">fit_nm</span><span class="op">$</span><span class="va">value</span>, <span class="va">fit_bfgs</span><span class="op">$</span><span class="va">value</span>, <span class="va">fit_nlm</span><span class="op">$</span><span class="va">objective</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;                  method fn_evals converged      nll</span></span>
<span><span class="co">#&gt; 1           Nelder-Mead       77      TRUE 122.8647</span></span>
<span><span class="co">#&gt; 2        BFGS + AD grad      101     FALSE 634.7822</span></span>
<span><span class="co">#&gt; 3 nlminb + AD grad+hess       12      TRUE 122.8647</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Contour plot with optimizer paths</span></span>
<span><span class="co"># Recompute paths by running each optimizer and collecting iterates</span></span>
<span></span>
<span><span class="co"># Helper: collect iterates via BFGS</span></span>
<span><span class="va">bfgs_trace</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">bfgs_nll</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">bfgs_trace</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">bfgs_trace</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1L</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;&lt;-</span> <span class="va">theta</span></span>
<span>  <span class="op">-</span><span class="fu">ll_normal</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">bfgs_trace</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span><span class="va">start</span>, fn <span class="op">=</span> <span class="va">bfgs_nll</span>, gr <span class="op">=</span> <span class="va">ngr</span>, method <span class="op">=</span> <span class="st">"BFGS"</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; [1]  98.48162 563.44563</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $value</span></span>
<span><span class="co">#&gt; [1] 634.7822</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $counts</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;      101      100 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="va">bfgs_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">bfgs_trace</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Helper: collect iterates via Nelder-Mead</span></span>
<span><span class="va">nm_trace</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">nm_nll</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">nm_trace</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">nm_trace</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1L</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;&lt;-</span> <span class="va">theta</span></span>
<span>  <span class="op">-</span><span class="fu">ll_normal</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">nm_trace</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span><span class="va">start</span>, fn <span class="op">=</span> <span class="va">nm_nll</span>, method <span class="op">=</span> <span class="st">"Nelder-Mead"</span>,</span>
<span>      control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit <span class="op">=</span> <span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; [1] 5.064595 2.072179</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $value</span></span>
<span><span class="co">#&gt; [1] 122.8647</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $counts</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       77       NA </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="va">nm_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">nm_trace</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Helper: collect iterates via nlminb</span></span>
<span><span class="va">nlm_trace</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">nlm_nll</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">nlm_trace</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">nlm_trace</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1L</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;&lt;-</span> <span class="va">theta</span></span>
<span>  <span class="op">-</span><span class="fu">ll_normal</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">nlm_trace</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">start</span>, objective <span class="op">=</span> <span class="va">nlm_nll</span>, gradient <span class="op">=</span> <span class="va">ngr</span>, hessian <span class="op">=</span> <span class="va">nhess</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; [1] 5.065030 2.072274</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 122.8647</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 11</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       12       11 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "both X-convergence and relative convergence (5)"</span></span>
<span><span class="va">nlm_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">nlm_trace</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build contour grid</span></span>
<span><span class="va">mu_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">7</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">sigma_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">4</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">nll_surface</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">mu_grid</span>, <span class="va">sigma_grid</span>, <span class="fu"><a href="https://rdrr.io/r/base/Vectorize.html" class="external-link">Vectorize</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">m</span>, <span class="va">s</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="op">-</span><span class="fu">ll_normal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">s</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/contour.html" class="external-link">contour</a></span><span class="op">(</span><span class="va">mu_grid</span>, <span class="va">sigma_grid</span>, <span class="va">nll_surface</span>, nlevels <span class="op">=</span> <span class="fl">30</span>,</span>
<span>        xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">mu</span><span class="op">)</span>, ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span>,</span>
<span>        main <span class="op">=</span> <span class="st">"Optimizer paths on NLL contours"</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"grey75"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Nelder-Mead path (subsample for clarity)</span></span>
<span><span class="va">nm_sub</span> <span class="op">&lt;-</span> <span class="va">nm_path</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">nm_path</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">nm_path</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">nm_sub</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">nm_sub</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"coral"</span>, lwd <span class="op">=</span> <span class="fl">1.5</span>, lty <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">nm_sub</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">nm_sub</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span>, pch <span class="op">=</span> <span class="fl">17</span>, col <span class="op">=</span> <span class="st">"coral"</span>, cex <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># BFGS path</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">bfgs_path</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">bfgs_path</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"steelblue"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, type <span class="op">=</span> <span class="st">"o"</span>,</span>
<span>      pch <span class="op">=</span> <span class="fl">19</span>, cex <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># nlminb path</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">nlm_path</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">nlm_path</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"forestgreen"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, type <span class="op">=</span> <span class="st">"o"</span>,</span>
<span>      pch <span class="op">=</span> <span class="fl">15</span>, cex <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># MLE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">mle_mu</span>, <span class="va">mle_sigma</span>, pch <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"black"</span>, cex <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>,</span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Nelder-Mead"</span>, <span class="st">"BFGS + AD grad"</span>, <span class="st">"nlminb + AD grad+hess"</span>, <span class="st">"MLE"</span><span class="op">)</span>,</span>
<span>       col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"coral"</span>, <span class="st">"steelblue"</span>, <span class="st">"forestgreen"</span>, <span class="st">"black"</span><span class="op">)</span>,</span>
<span>       lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="cn">NA</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">17</span>, <span class="fl">19</span>, <span class="fl">15</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>       lwd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, bty <span class="op">=</span> <span class="st">"n"</span>, cex <span class="op">=</span> <span class="fl">0.85</span><span class="op">)</span></span></code></pre></div>
<p><img src="optimizer-integration_files/figure-html/fig-optim-contour-1.png" class="r-plt" width="576"></p>
<p>The Nelder-Mead simplex method (no derivatives) requires many more
function evaluations and takes a wandering path. BFGS with the AD
gradient converges more efficiently. <code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb()</a></code> with both
gradient and Hessian can achieve the most direct path to the
optimum.</p>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<table class="table">
<colgroup>
<col width="33%">
<col width="33%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th>What you need</th>
<th>Function</th>
<th>R optimizer argument</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Gradient</td>
<td><code>score(loglik, theta)</code></td>
<td>
<code>gr</code> in <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code>, <code>gradient</code> in
<code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb()</a></code>
</td>
</tr>
<tr class="even">
<td>Hessian</td>
<td><code>hessian(loglik, theta)</code></td>
<td>
<code>hessian</code> in <code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb()</a></code> only</td>
</tr>
<tr class="odd">
<td>Observed information</td>
<td><code>observed_information(loglik, theta)</code></td>
<td>Post-optimization: invert for SEs</td>
</tr>
</tbody>
</table>
<p><strong>When to use which optimizer:</strong></p>
<ul>
<li>
<strong><code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> with BFGS</strong> — good default; use
<code>gr = function(theta) -score(ll, theta)</code>
</li>
<li>
<strong><code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb()</a></code></strong> — when you want second-order
convergence; supply both gradient and Hessian</li>
<li>
<strong>Nelder-Mead</strong> — fallback for non-smooth objectives;
doesn’t benefit from AD</li>
</ul>
<p><strong>Remember the sign convention:</strong> optimizers minimize,
MLE maximizes. Negate the log-likelihood, score, and Hessian when
passing to the optimizer.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Alexander Towell.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
